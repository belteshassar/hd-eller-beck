<div id="rules">
    <h1>Beck-film eller rättsfall från Högsta domstolen</h1>
    <p>Sedan några år tillbaka namnger Högsta domstolen de flesta av de mål som den avgör.
    Namnen för ibland tankarna till kriminalromaner eller -filmer. Klarar du att skilja på de två?
    Du kommer att få se tio titlar och din uppgift är att avgöra om titeln tillhör en Beck-film eller
    ett rättsfall från Högsta domstolen. <!--eller kanske båda, men det finns inget sådant exempel när detta skrivs--></p>
</div>
<div id="quiz"></div>
<div id="results">
  <div id="message"></div>
  <div id="info"></div>
  <div id="link"></div>
</div>
<div id="cRetry"></div>

<script>

class SPARQLQueryDispatcher {
  constructor( endpoint ) {
    this.endpoint = endpoint;
  }

  query( sparqlQuery ) {
    const fullUrl = this.endpoint + '?query=' + encodeURIComponent( sparqlQuery );
    const headers = { 'Accept': 'application/sparql-results+json' };

    return fetch( fullUrl, { headers } ).then( body => body.json() );
  }
}

let beckData, hdData;

const endpointUrl = 'https://query.wikidata.org/sparql';
const beckQuery = `SELECT ?title (YEAR(?date) AS ?year) ?regiLabel ?beckLabel ?article WHERE {
  ?item wdt:P179 wd:Q16939437;
        wdt:P1476 ?title;
        wdt:P577 ?date;
        wdt:P57 ?regi;
        p:P161 [ps:P161 ?beck; pq:P453 wd:Q13652117].
  ?article schema:about ?item;
           schema:isPartOf <https://sv.wikipedia.org/>.
  SERVICE wikibase:label { bd:serviceParam wikibase:language "sv,en,de". }
}`;
const hdQuery = `SELECT ?title ?nja (YEAR(?date) AS ?year) ?url WHERE {
  ?item wdt:P31 wd:Q96482904;
        wdt:P1476 ?title;
        wdt:P1031 ?nja;
        wdt:P577 ?date.
  OPTIONAL {?item wdt:P953 ?url.}
}`;

const correctMessage = 'Grattis, du svarade rätt.';
const wrongMessage = 'Tyvärr, du svarade fel.';

const quizContainer = document.getElementById('quiz');
const resultsContainer = document.getElementById('results');
const rulesContainer = document.getElementById('rules');
const messageContainer = document.getElementById('message');
const infoContainer = document.getElementById('info');
const linkContainer = document.getElementById('link');
const retryContainer = document.getElementById('cRetry');

function buildQuestion(value){
  return `<div id="title">${value['title']['value']}</div>
  <button id="beck">Beck-film</button> eller <button id="hd">rättsfall</button> ?`;
}

function showQuestion(){
  let selected;
  let hdEvent, beckEvent;
  // beck or hd?
  if (Math.random() < 0.0) {
    // select from Beck films
    hdEvent = displayWrongMessage;
    beckEvent = displayCorrectMessage;
  }
  else {
    // select from HD cases
    selected = hdData[Math.floor(Math.random()*hdData.length)];
    const titleInfo = `<p><b><i>${selected['title']['value']}</i></b> (${selected['nja']['value']}) är ett avgörande från ${selected['year']['value']}.`;
    const titleLink = `<a href="${selected['url']['value']}">Läs avgörandet</a> på Högsta domstolens hemsida.`;
    hdEvent = () => displayCorrectMessage(titleInfo, titleLink);
    beckEvent = displayWrongMessage(titleInfo, titleLink);
  }
  quizContainer.innerHTML = buildQuestion(selected);
  const hdButton = document.getElementById('hd');
  const beckButton = document.getElementById('beck');
  hdButton.addEventListener('click', hdEvent);
  beckButton.addEventListener('click', beckEvent);
}

function hideQuestion(){
  quizContainer.innerHTML = '';
}

function displayCorrectMessage(titleInfo, titleLink){
  messageContainer.innerHTML = correctMessage;
  displayTitleInfo(titleInfo, titleLink);
  retryContainer.innerHTML = '<button id="retry">Försök igen</button>';
  document.getElementById('retry').addEventListener('click', hideResults);
}

function displayWrongMessage(titleInfo, titleLink){
  messageContainer.innerHTML = wrongMessage;
  displayTitleInfo(titleInfo, titleLink);
  retryContainer.innerHTML = '<button id="retry">Försök igen</button>';
  document.getElementById('retry').addEventListener('click', hideResults);
}

function displayTitleInfo(titleInfo, titleLink){
  infoContainer.innerHTML = titleInfo;
  linkContainer.innerHTML = titleLink;
}

function hideResults(){
  messageContainer.innerHTML = '';
  infoContainer.innerHTML = '';
  linkContainer.innerHTML = '';
  retryContainer.innerHTML = '';
}

const queryDispatcher = new SPARQLQueryDispatcher( endpointUrl );
beckPromise = queryDispatcher.query( beckQuery ).then( (value) => {beckData = value['results']['bindings'];} );
hdPromise = queryDispatcher.query( hdQuery ).then( (value) => {hdData = value['results']['bindings'];} );
Promise.all([beckPromise, hdPromise]).then( showQuestion );

// Fetch and process data from Wikidata.
// To be created, for now use the const above.
// Build question and add answer buttons
// on submit, compare to answer key and display message

</script>
